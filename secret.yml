---
- name: Playbook to deal with secrets
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  vars:
    version: "v0.12.4"
  collections:
    - kubernetes.core
    
  tasks:
    - name: Add a secret to Kubernetes default
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          type: Opaque
          metadata:
            name: my-secret
            namespace: default
          data:
            username: "{{ username | b64encode }}"
            password: "{{ password | b64encode }}"
      register: secret
      
    - name: Debug secret
      ansible.builtin.debug:
        var: secret
        
    - name: Download controller yaml
      ansible.builtin.get_url: 
        url: "https://github.com/bitnami-labs/sealed-secrets/releases/download/{{ version }}/controller.yaml"
        dest: "./controller.yaml"
        
    - name: Replace old rbac apiVersion 
      ansible.builtin.lineinfile:
        path: ".controller.yaml"
        regexp: '^apiVersion: rbac\.authorization\.k8s\.io\/v1'
        line: "apiVersion: rbac.authorization.k8s.io/v1"
        
    - name: Apply controller to environment
      kubernetes.core.k8s:
        state: present
        src: "./controller.yaml"
    
